---
title: "mapping_markdown"
author: "Emily Dombrowski"
date: "2024-12-08"
output: html_document
---

```{r load libraries and data}
library(sf)
library(dplyr)
library(ggplot2)

lake_regions <- st_read("mapping_files")
regions_sf <- st_as_sf(lake_regions)

temp_data <- read.csv("./data/temperature/jplMURSST41_027a_a010_bc86.csv")
nrow(temp_data) #2406811
```

```{r data cleaning}

# change data columns in lake regions
regions_sf <- rename(regions_sf, regions = GNIS_NAME)

# remove variables that aren't relevant/na for smaller df
regions_sf <- regions_sf %>%
  select(-OBJECTID, -COMID, -REACHCODE, -FTYPE, -GDB_GEOMAT)

# convert temp data to number categories to numeric
temp_data <- temp_data %>%
  mutate(
    longitude = as.numeric(longitude),
    latitude = as.numeric(latitude),
    analysed_sst = as.numeric(analysed_sst)
  )

# filter for na and nan
temp_clean <- temp_data %>%
  filter(!is.na(longitude) & !is.nan(longitude)) %>%
  filter(!is.na(latitude) & !is.nan(latitude)) %>%
  filter(!is.na(analysed_sst) & !is.nan(analysed_sst)) 
nrow(temp_clean) # 554435; reduced from orginal set

# take a look at data
str(temp_clean)
summary(temp_clean)

# convert to a shape file for plotting
temp_sf <- st_as_sf(temp_clean, coords = c("longitude", "latitude"), crs = 4326)

# make sure crs is consistent
st_crs(temp_sf)
st_crs(regions_sf)

# spatial join
# st_within is applied to maintain only observations that fall within the regions
regions_temp <- st_join(temp_sf, regions_sf,
                        join = st_within)
nrow(regions_temp) #554435

# filter out na for region so we are only left with lc regions
regions_temp <- regions_temp %>%
  filter(!is.na(regions))
nrow(regions_temp) #431430

# the final geometries are different classes; not what I am looking for
class(regions_sf$geometry) # [1] "sfc_POLYGON" "sfc"  
class(regions_temp$geometry) # [1] "sfc_POINT" "sfc"

# Extract the polygons from the joined data frame
# regions_temp$geometry <- 
#  regions_sf$geometry[match(regions_temp$regions,
#                            regions_sf$regions)] 

# Check geometry type...yay!
# class(regions_temp$geometry)

# check if all regions got applied over
unique(regions_temp$regions)
```

Plot lakes by region to see if it looks how I expect: 
- It looks like this data set breaks the lake into a few more regions than I would. Still useful!
```{r preliminary visualization}
baseMap <- ggplot(regions_sf) +
  geom_sf(aes(fill = regions)) 
baseMap
```

Collapse data into month by month averages per basin for plotting
```{r}
# add a column for month
 regions_temp <- regions_temp %>%
  mutate(month = format(as.Date(time), "%m-%Y"))

names(regions_temp)

small_df <- regions_temp %>%
  st_drop_geometry() %>%
  select(-time, -AREASQKM, -SHAPESTAre, -SHAPESTLen, -mask) %>%
  filter(!is.na(regions))

# create a new df with monthly mean temperature
small_df <- small_df %>%
  group_by(regions, month) %>%
  summarize(avg_temp = mean(analysed_sst, na.rm = TRUE), .groups = 'drop')
```

Rejoin spatial geometries:
```{r}
joined_df <- left_join(small_df, regions_sf, by = "regions")

joined_sf <- st_as_sf(joined_df)
```

Plots: 
```{r}
ggplot(joined_df, aes(x = month, y = avg_temp, color = regions)) +
  geom_point() +
  labs(title = "Monthly average temperature by lake region",
       x = "Month", y = "Average temperature (°C)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

july_data <- joined_sf %>% 
  filter(month == "07-2023")

# Create the map
ggplot(july_data) +
  geom_sf(aes(fill = avg_temp), color = "black") + 
  scale_fill_gradient(low = "lightblue", high = "maroon", name = "Average temperature (°C)") +
  labs(title = "Average temperature in July") +
  theme_bw() 
```
