---
title: "bioenergetics"
author: "Emily Dombrowski"
date: "2024-12-12"
output: html_document
---

A markdown file to combine data from chla_mapping.Rmd & mapping_markdown.Rmd with the model explored in data_wrangling.Rmd.

Inputs: 
* Zebra and quagga mussels bioenergetics values
* Average monthly temperature per lake champlain basin
* Average monthly chlorophyll content per lake champlain basin

Outputs: 
* Bioenergetics growth rate graphs
* Spatial representations of mussel growth in each lake basin

1. Load libraries
```{r}
library(dplyr) # for cleaning and wrangling data frames
library(ggplot2) # for visualizing data
library(sf) # for mapping data
```

2. Load data
```{r}
# lake shape files
temp <- st_read("./data/monthly_temp_sf")
chla <- st_read("./data/monthly_chla_sf")

# remove data from december 2023
temp <- temp %>%
    filter(month != "12-2023") 
chla <- chla %>%
  filter(month != "12-2023")

# drop geometry for a left join
temp_df <- st_drop_geometry(temp)
chla_df <- st_drop_geometry(chla)

# create a new column that converts ERDAP chlorphyll a data
# step 1: mg to g (* 0.001)
# step 2: multiply chla by a scaling factor (80) to account for other types of plankton
chla_df$chla_g <- chla_df$avg_chla * 0.001 * 80

# use left join to get combine chla and temperature data frame
env_dat <- left_join(temp_df, chla_df, by = c("regions", "month")) 

# read in bioenergetics parameters
parameters <- read.csv("bioenergetics_parameters.csv")

# lake shape files
lake_regions <- st_read("mapping_files")
regions_sf <- st_as_sf(lake_regions)
```

3. load functions for bioenergetics model
```{r}
temp_dependence <- function(temp, opt_temp) {
  exp(-((temp - opt_temp)^2) / 50)
}

growth_potential <- function(weight, temp, food_avail, a_c, b_c, opt_temp_c, a_r, b_r, opt_temp_r, e_f, e_u) {
  # Consumption
  C <- a_c * weight^b_c * temp_dependence(temp, opt_temp_c) * food_avail
  
  # Respiration
  R <- a_r * weight^b_r * temp_dependence(temp, opt_temp_r)
  
  # Egestion and Excretion
  F <- e_f * C
  U <- e_u * (C - F)
  
  # Growth
  G <- C - (R + F + U)
  
  return(G)
}

```

4. Use parameters in environmental data and parameter files to inform models
```{r}
growth_results <- expand_grid(
  env_dat, 
  parameters
) %>% 
  mutate(
    growth = growth_potential(
      weight = 1,
      temp = avg_temp, 
      food_avail = chla_g, 
      a_c = a_c, 
      b_c = b_c, 
      opt_temp_c = opt_temp_c, 
      a_r = a_r, 
      b_r = b_r, 
      opt_temp_r = opt_temp_r, 
      e_f = e_f, 
      e_u = e_u
    )
  )

```

5. Plot results
```{r}
growth_results_subset <- growth_results %>%
  filter(regions %in% c("Main_Central", 
                      "South_Lake", "Malletts", "NE_Channel"))
# error with missiqoui

ggplot(growth_results, aes(x = month, y = growth, color = mussel, group = mussel)) + 
  geom_line() + 
  xlab("Month") + 
  ylab("Growth rate (g/g day)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~ regions)

ggplot(growth_results_subset, aes(x = month, y = growth, color = mussel, group = mussel)) + 
  geom_line() +
  xlab("Month") + 
  ylab("Growth rate (g/g day)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~ regions) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 6), 
        legend.title = element_text(size = 8))
```

6. Map results
```{r}
# change data columns in lake regions
regions_sf <- rename(regions_sf, regions = GNIS_NAME)
growth_df <- left_join(growth_results, regions_sf, by = "regions") 
growth_sf <- st_as_sf(growth_df)

# filter for one month to start
aug_data <- growth_sf %>% 
  filter(month == "08-2024")

ggplot(aug_data) +
  geom_sf(aes(fill = growth), color = "black") + 
  scale_fill_viridis_c(name = "Average mussel growth (g/ g day)") +
  facet_wrap(~mussel) +
  theme_bw()
```